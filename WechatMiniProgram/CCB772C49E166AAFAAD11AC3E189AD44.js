var e=require("@babel/runtime/helpers/regeneratorRuntime.js"),r=require("@babel/runtime/helpers/asyncToGenerator.js"),n=require("6CA8B5449E166AAF0ACEDD43BE69AD44.js"),t=(require("99370B849E166AAFFF51638335D9AD44.js"),[]),o="",s="",c="",i="",a=function(e){(0,n.print)("BLE:",e)},u=function(){return new Promise((function(e,r){wx.openBluetoothAdapter({success:function(r){e({ok:!0,errCode:0,errMsg:""})},fail:function(r){a(r),e({ok:!1,errCode:r.errCode,errMsg:r.errMsg})}})}))},d=function(){return new Promise((function(e,r){wx.closeBluetoothAdapter({success:function(r){e({ok:!0,errCode:0,errMsg:""})},fail:function(r){e({ok:!1,errCode:r.errCode,errMsg:r.errMsg})}})}))},f=function(e){return new Promise((function(r,n){for(var s=!1,c=0,i=t;c<i.length;c++){var u=i[c];if(u.name===e){s=!0,o=u.deviceId;break}}s?wx.createBLEConnection({deviceId:o,success:function(e){a(e),r({ok:!0,errCode:0,errMsg:""})},fail:function(e){a("connect fail"),a(e),r({ok:!1,errCode:e.errCode,errMsg:e.errMsg})}}):r({ok:!1,errCode:-1,errMsg:"Name error,Device does not exist"})}))},g=function(){return new Promise((function(e,r){wx.closeBLEConnection({deviceId:o,success:function(r){e({ok:!0,errCode:0,errMsg:""})},fail:function(r){e({ok:!1,errCode:r.errCode,errMsg:r.errMsg})}})}))},C=function(e){return new Promise((function(r,n){wx.setBLEMTU({deviceId:o,mtu:e,success:function(e){r({ok:!0,errCode:0,errMsg:""})},fail:function(e){r({ok:!1,errCode:e.errCode,errMsg:e.errMsg})}})}))},l=function(){var n=r(e().mark((function r(n,t){var l;return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return l={},e.next=3,d();case 3:return e.next=5,u();case 5:return e.next=7,f(n);case 7:if((l=e.sent).ok){e.next=12;break}return l={ok:!1,errMsg:"蓝牙连接失败|"+l.errCode+"|"+l.errMsg,errCode:10001},t(l),e.abrupt("return",l);case 12:return e.next=14,new Promise((function(e,r){wx.getBLEDeviceServices({deviceId:o,success:function(r){a("device services:"),a(r.services);for(var n=0;n<r.services.length;n++){var t;if(a(r.services[n].uuid),"0000FFF0-0000-1000-8000-00805F9B34FB"===(t=r.services[n].uuid.toUpperCase()))return s="0000FFF0-0000-1000-8000-00805F9B34FB",e({ok:!0,errCode:0,errMsg:""});if("FFF0"===t)return s="FFF0",e({ok:!0,errCode:0,errMsg:""})}e({ok:!1,errCode:2e4,errMsg:"服务未找到"})},fail:function(r){e({ok:!1,errCode:r.errCode,errMsg:r.errMsg})}})}));case 14:if((l=e.sent).ok){e.next=20;break}return g(),l={ok:!1,errMsg:"获取服务失败|"+l.errCode+"|"+l.errMsg,errCode:10002},t(l),e.abrupt("return",l);case 20:return e.next=22,new Promise((function(e,r){wx.getBLEDeviceCharacteristics({deviceId:o,serviceId:s,success:function(r){var n,t;(a("device getBLEDeviceCharacteristics:"),a(r.characteristics),r.characteristics.length<2)?e({ok:!1,errCode:2e4,errMsg:"特征值出错"}):(n=r.characteristics[0].uuid.toUpperCase(),t=r.characteristics[1].uuid.toUpperCase(),"0000FFF2-0000-1000-8000-00805F9B34FB"===n&&"0000FFF1-0000-1000-8000-00805F9B34FB"===t||"0000FFF1-0000-1000-8000-00805F9B34FB"===n&&"0000FFF2-0000-1000-8000-00805F9B34FB"===t?(c="0000FFF2-0000-1000-8000-00805F9B34FB",i="0000FFF1-0000-1000-8000-00805F9B34FB",e({ok:!0,errCode:0,errMsg:""})):"FFF2"===n&&"FFF1"===t||"FFF1"===n&&"FFF2"===t?(c="FFF2",i="FFF1",e({ok:!0,errCode:0,errMsg:""})):e({ok:!1,errCode:2e4,errMsg:"特征值出错"}))},fail:function(r){e({ok:!1,errCode:r.errCode,errMsg:r.errMsg})}})}));case 22:if((l=e.sent).ok){e.next=28;break}return g(),l={ok:!1,errMsg:"获取特性失败|"+l.errCode+"|"+l.errMsg,errCode:10003},t(l),e.abrupt("return",l);case 28:return e.next=30,new Promise((function(e,r){wx.notifyBLECharacteristicValueChange({state:!0,deviceId:o,serviceId:s,characteristicId:i,success:function(r){e({ok:!0,errCode:0,errMsg:""})},fail:function(r){e({ok:!1,errCode:r.errCode,errMsg:r.errMsg})}})}));case 30:if((l=e.sent).ok){e.next=36;break}return g(),l={ok:!1,errMsg:"订阅失败|"+l.errCode+"|"+l.errMsg,errCode:10004},t(l),e.abrupt("return",l);case 36:return e.next=38,C(250);case 38:return t(l={ok:!0,errMsg:"",errCode:0}),e.abrupt("return",l);case 41:case"end":return e.stop()}}),r)})));return function(e,r){return n.apply(this,arguments)}}(),v=function(e){return new Promise((function(r,n){wx.writeBLECharacteristicValue({deviceId:o,serviceId:s,characteristicId:c,value:e,success:function(e){r({ok:!0,errCode:0,errMsg:""})},fail:function(e){r({ok:!1,errCode:e.errCode,errMsg:e.errMsg})}})}))},F=function(){var n=r(e().mark((function r(n,t){var o,s,c,i,a,u;return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==n.length){e.next=2;break}return e.abrupt("return");case 2:if(!t){e.next=12;break}for(n=unescape(encodeURIComponent(n)),o=new ArrayBuffer(2*n.length),s=new Uint8Array(o),c=0;c<s.length;c++)s[c]=n.charCodeAt(c);return e.next=9,v(o);case 9:return e.abrupt("return",e.sent);case 12:for(i=new ArrayBuffer(n.length),a=new Uint8Array(i),u=0;u<a.length;u++)a[u]=n.charCodeAt(u);return e.next=17,v(i);case 17:return e.abrupt("return",e.sent);case 18:case"end":return e.stop()}}),r)})));return function(e,r){return n.apply(this,arguments)}}(),h=function(){var n=r(e().mark((function r(n,t){var o,s,c,i,a,u;return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==n.length){e.next=2;break}return e.abrupt("return");case 2:if(!t){e.next=11;break}for(o=new ArrayBuffer(n.length/2),s=new Uint8Array(o),c=0;c<s.length;c++)s[c]=parseInt(n.substr(2*c,2),16);return e.next=8,v(o);case 8:return e.abrupt("return",e.sent);case 11:for(i=new ArrayBuffer(n.length),a=new Uint8Array(i),u=0;u<a.length;u++)a[u]=n.charCodeAt(u);return e.next=16,v(i);case 16:return e.abrupt("return",e.sent);case 17:case"end":return e.stop()}}),r)})));return function(e,r){return n.apply(this,arguments)}}();module.exports={openBluetoothAdapter:u,closeBluetoothAdapter:d,getBluetoothAdapterState:function(){return new Promise((function(e,r){wx.getBluetoothAdapterState({success:function(r){r.available?e({ok:!0,errCode:0,errMsg:""}):(a(r),e({ok:!1,errCode:2e4,errMsg:"蓝牙适配器关闭"}))},fail:function(r){a(r),e({ok:!1,errCode:r.errCode,errMsg:r.errMsg})}})}))},startBluetoothDevicesDiscovery:function(e){t=[],wx.onBluetoothDeviceFound((function(r){var n=r.devices[0].name?r.devices[0].name:r.devices[0].localName;if(n){for(var o=0,s=t;o<s.length;o++){var c=s[o];if(c.name===n)return c.rssi=r.devices[0].RSSI,void e(n,c.rssi)}t.push({name:n,rssi:r.devices[0].RSSI,deviceId:r.devices[0].deviceId}),e(n,r.devices[0].RSSI)}})),wx.startBluetoothDevicesDiscovery({allowDuplicatesKey:!0,success:function(e){console.log(e)},fail:function(e){console.log(e),wx.showModal({showCancel:"false",confirmText:"我知道了",title:"调用蓝牙失败",content:"请检查权限中定位及蓝牙是否开启"})}})},stopBluetoothDevicesDiscovery:function(){return new Promise((function(e,r){wx.stopBluetoothDevicesDiscovery({success:function(r){e({ok:!0,errCode:0,errMsg:""})},fail:function(r){e({ok:!1,errCode:r.errCode,errMsg:r.errMsg})}})}))},easyConnect:l,closeBLEConnection:g,onBLEConnectionStateChange:function(e){wx.onBLEConnectionStateChange((function(r){r.connected||e()}))},onBLECharacteristicValueChange:function(e){wx.onBLECharacteristicValueChange((function(r){for(var n=new Uint8Array(r.value),t="",o="",s=0;s<n.length;s++)t+=n[s].toString(16).padStart(2,"0"),o+=String.fromCharCode(n[s]);e(decodeURIComponent(escape(o)),t)}))},onBLECharacteristicValueChange1:function(e){wx.onBLECharacteristicValueChange((function(r){for(var n=new Uint8Array(r.value),t="",o=0;o<n.length;o++)t+=n[o].toString(16).padStart(2,"0"),String.fromCharCode(n[o]);e(0,t.toUpperCase())}))},easySendData:F,easySendData1:h};