var t=require("../../@babel/runtime/helpers/createForOfIteratorHelper"),e=require("../../@babel/runtime/helpers/regeneratorRuntime"),a=require("../../@babel/runtime/helpers/asyncToGenerator"),i=n(require("../../53ECD1029E166AAF358AB905D784D591.js"));n(require("../../C09BCC729E166AAFA6FDA4750264D591.js"));function n(t){return t&&t.__esModule?t:{default:t}}var r=require("../../37FA01939E166AAF519C69944194D591.js"),s=0,o=0,c=0,u=0;function h(t,e){return d.apply(this,arguments)}function d(){return(d=a(e().mark((function t(a,i){return e().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r.stopBluetoothDevicesDiscovery(),t.next=3,r.easyConnect(a,(function(){}));case 3:t.sent.ok?a.startsWith("@")?(r.easySendData("CONNECT OK\n",!1),wx.navigateTo({url:"../device/device?Ver=3.47&GM="+(c?1:0)}),i.hideLoading()):a.startsWith("CAN-")?i.data.NewUI?(wx.navigateTo({url:"../device2/device?Ver=3.47&GM="+(c?1:0)}),i.hideLoading()):(wx.navigateTo({url:"../NewUI/NewUI?GM="+(c?1:0)}),i.hideLoading()):a.startsWith("CAN_")&&(wx.navigateTo({url:"../NewUI1/NewUI?GM="+c}),i.hideLoading()):o<5?(o+=1,h(a,i),console.log("失败！正在重新连接"+o)):(i.hideLoading(),l("连接失败"),i.startDiscovery());case 5:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function l(t){wx.showToast({title:t,icon:"none",duration:2e3})}function v(t){return wx.getStorageSync(t)}function w(t,e){wx.setStorageSync(t,e)}Page({data:{deviceListData:[],deviceListDataShow:[],CMD:"0x",GM:0,SOC:35,NewUI:1,ShowUI:0,Start:0},onShareAppMessage:function(){},onLoad:function(t){var e=wx.getAccountInfoSync();c=t.GM?1:v("GM"),"release"!=e.miniProgram.envVersion&&(c=1),"develop"==e.miniProgram.envVersion&&(u=0,c=2);var a=v("UI");this.setData({NewUI:0==a?0:a}),this.setData({GM:c});var i=this;setInterval((function(){i.setData({deviceListDataShow:i.data.deviceListData})}),600)},onShow:function(){var t=this;this.setData({deviceListData:[],Start:0}),this.setData({deviceListDataShow:[]}),setTimeout((function(){t.startDiscovery()}),500),setTimeout((function(){t.startDiscovery()}),1e3),setTimeout((function(){t.startDiscovery()}),1500),this.data.GM&&wx.getClipboardData({success:function(t){var e=t.data;if((e=e.replace(/[Oo]/g,"0")).startsWith("0x")){i.default.hex_md5("Check"+e+"@t*s$e#T.'1)`").match(/(....)$/);for(var a=(Number(e)+19880914).toString(16).substring(4,8),n=RegExp.$1,r=Number(e),s=0,o=r.toString(),c=0;c<o.length;c++)s+=o.charCodeAt(c);var u=(Math.trunc(r/655)*s).toString(16),h=u.substr(u.length-6,6);wx.setClipboardData({data:"设备ID:"+e+"\n5.0之前蓝牙密码:"+n+"\n5.0及之后蓝牙密码:"+a+"\n5.24及之后系统密码:"+h})}}})},Scan:function(){this.setData({Start:1}),this.startDiscovery()},onPullDownRefresh:function(){this.setData({deviceListData:[]}),this.setData({deviceListDataShow:[]});var t=this;setTimeout((function(){wx.stopPullDownRefresh(),t.startDiscovery()}),500)},listViewTap:function(t){var i=this;return a(e().mark((function a(){var n;return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.currentTarget.dataset.name.match(/^(CAN[\-\_]|@)/)?(n=i,o=0,r.stopBluetoothDevicesDiscovery(),s=t.currentTarget.dataset.name,wx.showToast({title:"设备连接中",icon:"loading",duration:46e5,mask:!0}),h(s,n)):(a="未知设备",c="不支持此蓝牙设备",wx.showModal({title:a,content:c,showCancel:!1}));case 1:case"end":return e.stop()}var a,c}),a)})))()},hideLoading:function(){wx.hideLoading()},CMDInput:function(t){this.setData({CMD:t.detail.value})},SetUI1:function(){this.setData({NewUI:1}),w("UI",1),u&&wx.navigateTo({url:"../NewUI/NewUI"})},SetUI0:function(){this.setData({NewUI:0}),w("UI",0),u&&wx.navigateTo({url:"../device2/device?Ver=3.47&GM="+c})},startDiscovery:function(){var i=this;return a(e().mark((function a(){var n,s;return e().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=i).setData({ShowUI:u?1:0}),e.next=4,r.openBluetoothAdapter();case 4:(s=e.sent).ok?(wx.showToast({title:"正在搜索中",icon:"loading",duration:2e6}),console.log("start search"),n.setData({Start:1}),r.startBluetoothDevicesDiscovery((function(e,a){var i,r=t(n.data.deviceListData);try{for(r.s();!(i=r.n()).done;){var s=i.value;if(s.name.startsWith("CAN-")&&n.setData({ShowUI:1}),s.name===e)return void(s.rssi=a)}}catch(t){r.e(t)}finally{r.f()}n.data.deviceListData.push({name:e,rssi:a}),setTimeout((function(){wx.hideToast()}),1e3)}))):s.errMsg.match("调试")?(wx.navigateTo({url:"../NewUI1/NewUI?GM="+c}),wx.hideLoading()):(console.log(s.errMsg),wx.showModal({showCancel:"false",confirmText:"我知道了",title:"调用蓝牙失败",content:"请检查权限中定位及蓝牙是否开启或重启小程序"}));case 6:case"end":return e.stop()}}),a)})))()}});