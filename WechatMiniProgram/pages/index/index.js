var t,e=require("../../@babel/runtime/helpers/createForOfIteratorHelper"),a=require("../../@babel/runtime/helpers/regeneratorRuntime"),n=require("../../@babel/runtime/helpers/asyncToGenerator"),i=(t=require("../../FB46E7B39E166AAF9D208FB4AE23EFC4.js"))&&t.__esModule?t:{default:t},r=require("../../6754D5619E166AAF0132BD66E613EFC4.js");var s,o=require("../../2E18F0939E166AAF487E98946523EFC4.js"),c=0,u=0,h=0,d=0;function w(t,e){return l.apply(this,arguments)}function l(){return(l=n(a().mark((function t(e,n){return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return o.stopBluetoothDevicesDiscovery(),(0,r.print)("IDX:","Connect "+e),t.next=4,o.easyConnect(e,(function(){}));case 4:t.sent.ok?e.startsWith("@")?(o.easySendData("CONNECT OK\n",!1),wx.navigateTo({url:"../device/device?Ver=3.47&GM="+(h?1:0)}),wx.hideLoading()):e.startsWith("CAN-")?n.data.NewUI?(wx.navigateTo({url:"../device2/device?Ver=3.47&GM="+(h?1:0)}),wx.hideLoading()):(wx.navigateTo({url:"../NewUI/NewUI?GM="+(h?1:0)}),wx.hideLoading()):e.startsWith("CAN_")&&(wx.navigateTo({url:"../NewUI1/NewUI?GM="+h}),wx.hideLoading()):u<5?(u+=1,w(e,n),console.log("失败！正在重新连接"+u)):(wx.hideLoading(),v("连接失败"),n.startDiscovery());case 6:case"end":return t.stop()}}),t)})))).apply(this,arguments)}function v(t){wx.showToast({title:t,icon:"none",duration:2e3})}function f(t,e){wx.setStorageSync(t,e)}Page({data:{deviceListData:[],deviceListDataShow:[],CMD:"0x",GM:0,SOC:35,NewUI:1,ShowUI:0},onShareAppMessage:function(){},onLoad:function(t){var e=wx.getAccountInfoSync();h=0,"trial"==e.miniProgram.envVersion&&(h=1),"develop"==e.miniProgram.envVersion&&(h=2);var a,n=(a="UI",wx.getStorageSync(a));this.setData({NewUI:0==n?0:n}),this.setData({GM:h}),s=this,setInterval((function(){s.setData({deviceListDataShow:s.data.deviceListData})}),600)},InitSearch:function(){d||this.startDiscovery()},onShow:function(){this.setData({deviceListData:[]}),this.setData({deviceListDataShow:[]}),setTimeout((function(){s.InitSearch()}),500),setTimeout((function(){s.InitSearch()}),1500),setTimeout((function(){s.InitSearch(),d=0}),2500),h&&wx.getClipboardData({success:function(t){var e=t.data;if((e=e.replace(/[Oo]/g,"0")).startsWith("0x")){i.default.hex_md5("Check"+e+"@t*s$e#T.'1)`").match(/(....)$/);for(var a=(Number(e)+19880914).toString(16).substring(4,8),n=RegExp.$1,r=Number(e),s=0,o=r.toString(),c=0;c<o.length;c++)s+=o.charCodeAt(c);var u=(Math.trunc(r/655)*s).toString(16),h=u.substr(u.length-6,6);wx.setClipboardData({data:"设备ID:"+e+"\n5.0之前蓝牙密码:"+n+"\n5.0及之后蓝牙密码:"+a+"\n5.24及之后系统密码:"+h})}}})},onPullDownRefresh:function(){this.setData({deviceListData:[]}),this.setData({deviceListDataShow:[]});var t=this;setTimeout((function(){wx.stopPullDownRefresh(),t.startDiscovery()}),500)},listViewTap:function(t){var e=this;return n(a().mark((function n(){var i;return a().wrap((function(a){for(;;)switch(a.prev=a.next){case 0:t.currentTarget.dataset.name.match(/^(CAN[\-\_]|@)/)?(i=e,u=0,o.stopBluetoothDevicesDiscovery(),c=t.currentTarget.dataset.name,wx.showToast({title:"设备连接中",icon:"loading",duration:46e5,mask:!0}),w(c,i)):(n="未知设备",r="不支持此蓝牙设备",wx.showModal({title:n,content:r,showCancel:!1}));case 1:case"end":return a.stop()}var n,r}),n)})))()},SetUI1:function(){this.setData({NewUI:1}),f("UI",1)},SetUI0:function(){this.setData({NewUI:0}),f("UI",0)},startDiscovery:function(){return n(a().mark((function t(){var n;return a().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return s.setData({ShowUI:0}),t.next=3,o.openBluetoothAdapter();case 3:(n=t.sent).ok?(wx.showToast({title:"正在搜索中",icon:"loading",duration:5e3}),(0,r.print)("IDX:","Start BLE Search"),d=1,o.startBluetoothDevicesDiscovery((function(t,a){var n,i=e(s.data.deviceListData);try{for(i.s();!(n=i.n()).done;){var r=n.value;if(r.name.startsWith("CAN-")&&s.setData({ShowUI:1}),r.name===t)return void(r.rssi=a)}}catch(t){i.e(t)}finally{i.f()}s.data.deviceListData.push({name:t,rssi:a}),setTimeout((function(){wx.hideToast()}),1e3)}))):((0,r.print)("IDX:",n.errMsg),n.errMsg.match("目前蓝牙调试功能暂不支持")&&h?(wx.navigateTo({url:"../NewUI1/NewUI?GM="+h}),wx.hideLoading()):wx.showModal({showCancel:"false",confirmText:"我知道了",title:"调用蓝牙失败",content:"请检查权限中定位及蓝牙是否开启或重启小程序"}));case 5:case"end":return t.stop()}}),t)})))()}});